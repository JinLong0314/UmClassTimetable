
<!DOCTYPE html>
<html lang="zh-tw">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>課程表助手 Timetable Helper</title>
</head>
<body>

	<h2>課程表助手 Timetable Helper</h2>
	<p>By K. C. Ho</p>

	<form action="javascript:add()">
		<p>
			<label for="time">課程編號 Course Code</label>
			<input type="text" id="coursename" placeholder="DROP101-015" autocomplete="off">
			<input type="submit" value="加入 Add">
			<span id="error"></span>
		</p>
	</form>

	<h4>課程表 Timetable</h4>
	<p class="announce">重要聲明：下面列出的課程資訊可能已經過時，本工具之作者將不會對因閣下使用下述資料而產生的一切結果負任何責任，若要查閱最新資訊請參閱 <a href="http://isw.umac.mo">http://isw.umac.mo</a> !</p>
	<a href="javascript:lockToggle()" id="lock">
		<span id="lock-on">檢視模式<br><small>View Mode</small></span><span id="lock-off">修改模式<br><small>Edit Mode</small></span>
	</a>

	<div id="wrapper">
		<div id="overlay"></div>
		<div id="timetable">
			<div class="col timestamps"></div>
			<div class="col day-col">
				<div class="header">Mon</div>
			</div>
			<div class="col day-col">
				<div class="header">Tue</div> 
			</div>
			<div class="col day-col">
				<div class="header">Wed</div>
			</div>
			<div class="col day-col">
				<div class="header">Thu</div>
			</div>
			<div class="col day-col">
				<div class="header">Fri</div>
			</div>
			<div class="col day-col">
				<div class="header">Sat</div>
			</div>
			<div id="morning" class="daytime">上 午　M o r n i n g</div>
			<div id="afternoon" class="daytime">下 午　A f t e r n o o n</div>
			<div id="night" class="daytime">晚 上　N i g h t</div>
		</div>
	</div>

	<p>&nbsp;</p>

	<h4>課程 Courses</h4>
	<ul id="courselist">

	</ul>

	<script src="courses.js"></script>

	<script>

	var timetable = document.getElementById("timetable");
	var template = timetable.innerHTML;

	var courses = [
	];

	var allCourseMode = false;

	var used_colors = {};

	if(localStorage["coursesJson"]){
		courses = JSON.parse(localStorage["coursesJson"]);
	}

	var totalHeight = 600;
	var lineHeight = 12;

	var dayName = ["SUN","MON","TUE","WED","THU","FRI","SAT"];
	var dayDisp = [
		"星期日/Sun",
		"星期一/Mon",
		"星期二/Tue",
		"星期三/Wed",
		"星期四/Thu",
		"星期五/Fri",
		"星期六/Sat"
	];

	var errorDiv = document.getElementById("error");
	var courseListDiv = document.getElementById("courselist");

	var earliest = undefined;
	var latest = undefined;

	var heightOf1Min = 0;

	var wrapper = document.getElementById("wrapper");
	wrapper.style.height = (totalHeight + 60) + "px";



	function lockToggle(){
		if(localStorage["lockMode"] && localStorage["lockMode"]==="lock"){
			localStorage["lockMode"] = "unlock";
		}
		else{
			localStorage["lockMode"] = "lock";
		}
		genIt()
	}

	function genIt(courses_list){

//		courses = courses.sort(function(a,b){return a.code > b.code});

		var used_colors_list = used_colors;

		if(!courses_list){
			courses_list = courses;
			allCourseMode = false;

		}
		else{
			allCourseMode = true;

			for(var i=courses.length-1; i>=0; i--){
				courses_list.unshift(courses[i]);
			}
		}

		courseListDiv.innerHTML = "";

		if(
			allCourseMode===true ||
			(localStorage["lockMode"] && localStorage["lockMode"]==="lock")
		){
			document.getElementById("overlay").className = "lock";
			document.getElementById("lock").className = "lock";
			localStorage["lockMode"] = "lock";
			// document.getElementById("lock").innerHTML = "按此解鎖 Click to unlock<br><small>解鎖後，你將可以從課程表中刪除科目<br>Unlock to remove course(s) from timetable.</small>";
		}
		else{
			document.getElementById("overlay").className = "unlock";
			document.getElementById("lock").className = "unlock";
			// document.getElementById("lock").innerHTML = "按此鎖定 Click to lock<br><small>鎖定課程表能避免誤刪課程<br>Lock to protect course(s) from removing.</small>";
		}

		earliest = undefined;
		latest = undefined;

		timetable.innerHTML = template;

		document.getElementById("morning").style.height = 0 + "px";
		document.getElementById("night").style.height = 0 + "px";
		document.getElementById("afternoon").style.height = 0 + "px";

		var day = document.querySelectorAll(".col");

		for(var i=0; i<day.length; i++){
			day[i].style.height = totalHeight + 'px';
		}

		for(var i=0; i<courses_list.length; i++){
			var starttime = (parseInt(courses_list[i].start.substr(0,2)) * 60) + (parseInt(courses_list[i].start.substr(3,2)) * 1);
			var endtime = (parseInt(courses_list[i].end.substr(0,2)) * 60) + (parseInt(courses_list[i].end.substr(3,2)) * 1);

			courses_list[i].startStamp = starttime;
			courses_list[i].endStamp   = endtime;

			if(!earliest || earliest > starttime){
				earliest = starttime;
			}
			if(!latest || latest < endtime){
				latest = endtime;
			}
		}

		if(earliest === undefined){
			earliest = 11.5*60;
			latest = 16.5*60;
		}
		else{
			if(earliest > (9*60 + 30)){
				earliest -= 30;
			}
			if(latest < (18*60)){
				latest += 30;
			}

			if(earliest > (12.5 * 60)){
				earliest = (12.5 * 60);
			}
			if(latest < (15.5 * 60)){
				latest = (15.5 * 60);
			}
		}

		heightOf1Min = totalHeight / (latest - earliest);

		for(var i=0; i<courses_list.length; i++){

			var tmpLineHeight = lineHeight;

			var weekday = dayName.indexOf(courses_list[i].day);

			if(weekday > -1){

				if(allCourseMode === true){

					var basicHTML = "<small>" + courses_list[i].code + "<br><small>" + courses_list[i].start + "-" + courses_list[i].end + " @ " + courses_list[i].venue + "</small></small>";
					var prevFound = false;

					for(var k=0; k<i; k++){
						if(
							(courses_list[k].start === courses_list[i].start) &&
							(courses_list[k].end === courses_list[i].end) &&
							(courses_list[k].day === courses_list[i].day)
						){

							var div = document.getElementById(courses_list[k].code + "-" +courses_list[k].start + "-" +courses_list[k].end + "-" +courses_list[k].day);
							div.innerHTML += "<hr>" + basicHTML;
							prevFound = true;
							break;

						}
					}

					if(prevFound === true){
						continue;
					}
				}

				var div = document.createElement("a");

				// if(allCourseMode === false){
					div.href = "javascript:deleteIt('" + courses_list[i].code + "')";
				// }
				// else{
				// 	div.href = "javascript:void(0)";
				// }

				div.style.top = ((courses_list[i].startStamp - earliest) * heightOf1Min) + "px";

				var divHeight = ((courses_list[i].endStamp - courses_list[i].startStamp) * heightOf1Min - 12);

				div.style.height = divHeight + "px";

				var paddingTop = (divHeight - (tmpLineHeight*4)) / 2;

				if(allCourseMode === false){

					var basicHTML = courses_list[i].code + "<br><small><small>" + courses_list[i].name + "</small></small><br><small>" + courses_list[i].venue + "<br>" + courses_list[i].start + "-" + courses_list[i].end + "</small>";

					if(paddingTop > 0){
					 	div.innerHTML = basicHTML;
					}
					else{
						tmpLineHeight = 8;
						var paddingTop = (divHeight - (tmpLineHeight*3)) / 2;
						div.innerHTML = "<small>" + courses_list[i].code + "<br><small>" + courses_list[i].name + "</small><br>" + courses_list[i].start + "-" + courses_list[i].end + ", " + courses_list[i].venue + "</small>";
					}
				}
				else{
					tmpLineHeight = 9;
					var paddingTop = 7;
					div.innerHTML = basicHTML;

					div.id = courses_list[i].code + "-" +courses_list[i].start + "-" +courses_list[i].end + "-" +courses_list[i].day;
				}


				if(paddingTop > 0){
					div.style.paddingTop = paddingTop + "px";
					div.style.height = (divHeight - paddingTop) + "px";
				}
				else{
					div.style.paddingTop = "0px";
				}

				var background = undefined;

				if(used_colors_list[courses_list[i].code]){
					background = used_colors_list[courses_list[i].code];
				}
				else if(allCourseMode === false){
					for(var k=0; k<colors.length; k++){

						var used = false;

						for(var h in used_colors_list){
							if(colors[k] === used_colors_list[h]){
								used = true;
								break;
							}
						}

						if(used === false){
							break;
						}
					}
					background = colors[k];
					used_colors_list[courses_list[i].code] = colors[k];
				}

				if(background === undefined){
					background = "#cccccc";
				}

				div.style.borderColor = background;
				div.style.lineHeight = tmpLineHeight + "px";

				if(allCourseMode === false){
					var span = document.createElement("span");
					span.className = "cross";
					span.innerHTML = "&times;";
					span.style.height = tmpLineHeight + "px";
					div.appendChild(span);

					var span = document.createElement("span");
					span.className = "alt-text";
					span.innerHTML = courses_list[i].code;
					span.style.height = tmpLineHeight + "px";
					div.appendChild(span);
				}

				var bgDiv = document.createElement("div");
				bgDiv.className = "background";
				bgDiv.style.backgroundColor = background;
				bgDiv.style.zIndex = -1;

				// var altText = document.createElement("div");
				// altText.className = "alt";
				// altText.innerHTML = basicHTML;
				div.appendChild(bgDiv);
				// div.appendChild(altText);

				day[weekday].appendChild(div);
			}
		}

		var morning_height = 0;
		var night_height = 0;

		if(earliest < (13*60)){
			morning_height = (13*60 - earliest);
		}
		if(latest > (18*60)){
			night_height = (latest - 18*60);
		}

		if(morning_height < 1){
			morning_height = 0;
		}
		else{
			morning_height = morning_height * heightOf1Min + (lineHeight/2);
		}

		night_height = night_height * heightOf1Min - (lineHeight/2);

		document.getElementById("morning").style.height = morning_height + "px";
		document.getElementById("morning").style.lineHeight = morning_height + "px";

		if(morning_height < 48){
			document.getElementById("morning").style.lineHeight = 1 + "px";
		}

		if(night_height < 30){
			night_height = 0;
		}
		document.getElementById("night").style.height = night_height + "px";
		document.getElementById("night").style.lineHeight = night_height + "px";
		
		var afternoon_height = totalHeight - night_height - morning_height;
		morning_height += 35;

		document.getElementById("afternoon").style.top = morning_height + "px";
		document.getElementById("afternoon").style.height = afternoon_height + "px";
		document.getElementById("afternoon").style.lineHeight = afternoon_height + "px";

		for(var i=earliest; i<latest; i+=30){
			var stampTop = ((i - earliest) * heightOf1Min - (lineHeight/2));

			var stamp = document.createElement("div");
			stamp.style.height = (heightOf1Min * 30) + "px";
			stamp.style.top = stampTop + "px";

			var hour = parseInt(i/60);
			var min = (i - (hour*60));

			if(min < 10){
				min = '0' + min;
			}
			stamp.innerHTML = hour + ":" + min;
			day[0].appendChild(stamp);
		}

		var previousCourse = "";

		for(var i=0; i<courses_list.length; i++){
			if(courses_list[i].code !== previousCourse){
				previousCourse = courses_list[i].code;

				var li = document.createElement("li");
				li.innerHTML = "<h3>" + courses_list[i].code + "</h3>" +
								"<p>" + courses_list[i].name + "</p>" +
								"<p><u>上課時間及地點 Time & Venue</u></p>" +
								"<ul id='" + courses_list[i].code + "'></ul>" + 
								((courses_list[i].prof.replace(/\s/g, "")==="")
									? ""
									: "<p><u>講師 Lecturer</u><br>" + courses_list[i].prof + "</p>") +
								((courses_list[i].remark.replace(/\s/g, "")==="")
									? ""
									: "<p><u>備註 Remark</u><br>" + courses_list[i].remark.replace(/\n/g, "<br>") + "</p>");

				if(allCourseMode===true){
					if(i < courses.length){
						li.className = "inactive";
					}
				}

//				courseListDiv.insertBefore(li, courseListDiv.querySelector("li"));
				courseListDiv.appendChild(li);
			}

			var dayIndex = dayName.indexOf(courses_list[i].day);

			if(dayIndex > -1){
				ul = document.getElementById(courses_list[i].code);
				ul.innerHTML += "<li>" + "<b>" + dayDisp[dayIndex] + " - " + courses_list[i].start + "-" + courses_list[i].end + "</b><br>" + courses_list[i].venue + " (" + courses_list[i].type + ")" + "</li>";
			}
		}

		if(allCourseMode === false){
			localStorage["coursesJson"] = JSON.stringify(courses_list);
			used_colors = used_colors_list;
		}
		return true;
	}

	function look(coursecode){

		var courses_list_tmp = [];

		for(var i=0; i<courses_info.length; i++){
			if(courses_info[i].code.substr(0,7) === coursecode){
				courses_list_tmp.push(courses_info[i]);
			}
		}
		if(courses_list_tmp.length < 1){
			errorDiv.innerHTML = "課程不存在";
		}
		else{
			errorDiv.innerHTML = "";
			genIt(courses_list_tmp);
		}
	}

	function add(){
		var code_raw = document.getElementById("coursename").value;
		code_raw = code_raw.replace(/ /g, "").toUpperCase();

		if(code_raw.length < 8){
			look(code_raw);
			return;
		}

		var code = code_raw.substr(0,7) + "-" + code_raw.substr(-3);
		var existed = false;

		for(var i=0; i<courses.length; i++){
			if(courses[i].code === code){
				existed = true;
				break;
			}
		}

		if(existed === true){
			errorDiv.innerHTML = "課程已在課程表中";
			return genIt();
		}

		errorDiv.innerHTML = "";

		var count = 0;
		for(var i=0; i<courses_info.length; i++){
			if(courses_info[i].code === code){
				courses.push(courses_info[i]);
				count++;
			}
		}

		if(count === 0){
			errorDiv.innerHTML = "課程不存在";
		}
		else{
			errorDiv.innerHTML = "";
			document.getElementById("coursename").value = "";
		}

		genIt()
	}


	function deleteIt(courseCode){
		for(var i=courses.length-1; i>=0; i--){
			if(courses[i].code === courseCode){
				courses.splice(i, 1);
			}
		}
		used_colors[courseCode] = undefined;
		genIt();
	}

	genIt();

	</script>

	<style>
		body {
			font-family: arial;
		}
		body, h1, h2, h3, h4, h5, h6, p {
			padding:0;
			margin:0;
		}
		ul {
			margin-top:0;
			padding-left:20px;
		}
		li {
			padding:15px 0;
		}
		li.inactive {
			color:#aaa;
		}
		li ul li {
			padding:5px 0;
		}
		body {
			padding:20px;
		}
		form {
			padding:5px 0 25px 0;
		}
		div#wrapper {
			width:888px;
			overflow: hidden;
			position: relative;
			padding-top: 5px;
		}
		div#timetable {
			width:978px;
			position: relative;
			overflow: hidden;
			zoom:2;
			-webkit-transform:scale(0.5);
			-webkit-transform-origin:0 0;
			transform:scale(0.5);
			transform-origin:0 0;
			padding-top:30px;
		}
		div.col {
			width:130px;
			float:left;
			border:2px solid #ccc;
			border-top:0;
			border-bottom:0;
			margin:5px 0 5px 5px;
			position: relative;
		}
		div.col a, div.col div {
			position: absolute;
			left:0;
			right:0;
			border:1px solid #000;
			color:#000;
			text-align: center;
			font-size:12px;
			overflow:hidden;
			white-space: nowrap;
			text-overflow: ellipsis;
			text-decoration: none;
			padding:5px;
		}
		div.col div.header {
			top:-35px;
		}
		span.cross,
		span.alt-text,
		div.col div.background,
		div#wrapper div#overlay {
			position: absolute;
			left:0;
			top:0;
			right:0;
			bottom:0;
		}
		div#wrapper div#overlay.lock {
			z-index:99;
		}
		div#wrapper div#overlay.unlock {
			display: none;
		}
		span.cross,
		span.alt-text {
			font-size: 36px;
			margin: auto;
			opacity:0;
			padding:0 0 9px 0;
			color:#fff;
		}
		span.alt-text {
			font-size: 12px;
			padding:22px 0 0 0;
			-webkit-transform:scale(0.75);
			transform:scale(0.75);
			color:rgba(255,255,255,0.8);
		}
		div.col div.background {
			opacity:0.6;
			border:0;
		}
		div.col a:hover {
			color:rgba(255,255,255,0);
			z-index:10;
			-webkit-transform:scale(1.15);
			transform:scale(1.15);
		}
		div.col a:hover div.background {
			opacity:1;
		}
		div.col a:hover span.cross,
		div.col a:hover span.alt-text {
			opacity: 1;
		}
		div.col.timestamps {
			color:#ccc;
			border-color:#fff;
			width:40px;
		}
		div.col.timestamps div {
			text-align:right;
			font-size:11px;
			border:0;
			color:#aaa;
		}
		label {
			font-size: 13px;
		}
		input[type="text"]{
			font-size:16px;
			padding:5px;
			border:1px solid #ddd;
			-webkit-border-radius:3px;
			border-radius:3px;
			outline:0;
		}
		input[type="text"]:focus {
			border-color:#0089ff;
		}
		input[type="submit"]{
			padding:7px 12px;
			outline:0;
			background:#222;
			color:#fff;
			border:0;
			-webkit-border-radius:3px;
			border-radius:3px;
		}
		#error {
			color:crimson;
			font-size:14px;
			padding-left:10px;
			display: inline-block;
		}
		a#lock {
			display: block;
			text-align: center;
			height:48px;
			margin: 4px 0 5px;
			-webkit-border-radius:3px;
			border-radius:3px;
			text-decoration: none;
			font-size: 14px;
			line-height: 14px;
			overflow: hidden;
			background: #f1f1f1;
			width:140px;
			position: relative;
		}
		a#lock span {
			position: absolute;
			padding:10px 0 0;
			height:100px;
			overflow: hidden;
			-webkit-transition: left 0.2s ease-out, right 0.2s ease-out, background 0.2s ease-out;
			transition: left 0.2s ease-out, right 0.2s ease-out, background 0.2s ease-out;
		}
		a #lock-off {
			left:0;
		}
		a #lock-on {
			right:0;
		}
		a #lock-off,
		a #lock-on {
			width:70%;
		}
		a#lock.unlock #lock-off {
			background:#0A79F3;
			color:#fff;
			z-index:9;
		}
		a#lock.lock #lock-on {
			color:#666;
			background: #ccc;
			z-index:9;
		}
		a#lock.lock #lock-off,
		a#lock.unlock #lock-on {
			color:#ccc;
		}
		a#lock.lock #lock-off {
			left:-10px;
		}
		a#lock.unlock #lock-on {
			right:-10px;
		}
		li p {
			padding-top:8px;
		}
		li p, li li {
			font-size: 13px;
		}
		.daytime {
			position: absolute;
			z-index:-3;
			color:#ccc;
			font-size:28px;
			letter-spacing: 5px;
			left:55px;
			width:828px;
			text-align: center;
			overflow: hidden;
		}
		.daytime#morning {
			top:35px;
		}
		.daytime#night {
			bottom:5px;
		}
		.daytime#afternoon {
			border:5px dotted #ccc;
			border-left: 0;
			border-right: 0;
		}
		hr {
			border:0;
			background:transparent;
			border-top:1px dotted #000;
			padding:0;
			margin:3px;
		}
		p.announce {
			padding:5px 0;
			color:crimson;
			font-size: 14px;
		}
		p.announce a {
			color:crimson;
		}
	</style>

</body>
</html>
